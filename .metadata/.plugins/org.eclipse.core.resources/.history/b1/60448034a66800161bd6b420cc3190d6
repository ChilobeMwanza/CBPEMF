package drivers;

import java.io.BufferedOutputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.nio.ByteBuffer;
import java.nio.charset.Charset;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import org.eclipse.emf.ecore.EAttribute;
import org.eclipse.emf.ecore.EDataType;
import org.eclipse.emf.ecore.EEnum;
import org.eclipse.emf.ecore.EObject;
import org.eclipse.emf.ecore.util.EcoreUtil;

import change.Changelog;
import change.Event;
import change.SetEAttributeManyEvent;
import change.SetEAttributeSingleEvent;
import change.SetEReferenceManyEvent;
import change.SetEReferenceSingleEvent;
import change.UnsetEAttributeManyEvent;
import change.UnsetEReferenceManyEvent;
import change.UnsetEReferenceSingleEvent;
import gnu.trove.iterator.TIntIterator;
import gnu.trove.list.array.TIntArrayList;
import gnu.trove.map.TObjectIntMap;
import gnu.trove.map.hash.TObjectIntHashMap;

public class CBPBinarySerializer 
{
	private  final String classname = this.getClass().getSimpleName();
	private final String FORMAT_ID = "CBP_BIN"; 
	private final int FORMAT_VERSION = 1;
	private final int BITS_IN_BYTE = 8;
	//private final int BUFFER_SIZE = 8 * 1024;
	private final Charset STRING_ENCODING = StandardCharsets.UTF_8;
	
	private final List<Event> eventList;
    
    private final PersistenceManager manager;
    
    private final Changelog changelog; 
    
    private final EPackageElementsNamesMap ePackageElementsNamesMap;
    
    private OutputStream outputStream;
    private final TObjectIntMap<String> simpleTypeNameMap;
    
    public CBPBinarySerializer(PersistenceManager manager, Changelog changelog,EPackageElementsNamesMap 
    		ePackageElementsNamesMap,TObjectIntMap<String>   simpleTypeNameMap)
    {
    	this.manager =  manager;
        this.changelog = changelog;
        this.ePackageElementsNamesMap = ePackageElementsNamesMap;
        
        this.eventList = manager.getChangelog().getEventsList();
        
        this.simpleTypeNameMap = simpleTypeNameMap;
    }
    
    public void save(Map<?,?> options) throws IOException
    {
    	if(eventList.isEmpty())
    		return;
    	
    	
       
        outputStream = new BufferedOutputStream
        		(new FileOutputStream(manager.getURI().path(), manager.isResume()));
    
        
        //if we're not in resume mode, serialise initial entry
        if(!manager.isResume())
            writeInitialRecord(outputStream);
        
        for(Event e : eventList)
        {
        	switch(e.getEventType())
        	{
        	case Event.SET_EREFERENCE_SINGLE:
        		handleSetEReferenceSingleEvent((SetEReferenceSingleEvent)e,outputStream);
        		break;
        	case Event.SET_EREFERENCE_MANY:
        		handleSetEReferenceManyEvent((SetEReferenceManyEvent)e,outputStream);
        		break;
        	case Event.UNSET_EREFERENCE_MANY:
        		handleUnsetEReferenceManyEvent((UnsetEReferenceManyEvent)e, outputStream);
        		break;
        	case Event.UNSET_EREFERENCE_SINGLE:
        		 handleUnsetEReferenceSingleEvent((UnsetEReferenceSingleEvent)e, outputStream);
                 break;
        	case Event.SET_EATTRIBUTE_MANY:
        		handleSetEAttributeManyEvent((SetEAttributeManyEvent)e,outputStream);
        		break;
        	case Event.SET_EATTRIBUTE_SINGLE:
				handleSetEAttributeSingleEvent((SetEAttributeSingleEvent)e,outputStream);
				break;
        	}
        }
        
        // switch 
        changelog.clearEvents();
      	outputStream.close();
      	manager.setResume(true);
	
    }
    
    private void handleSetEAttributeSingleEvent(SetEAttributeSingleEvent e, OutputStream out)
	{
		EObject focus_obj = e.getFocusObj();
		
		EAttribute attr = e.getEAttribte();
		
		//EEnum df = (EEnum) e.getNewValue();
		
		//System.out.println(attr.getEContainingClass().);
	//	attr.getEContainingClass()
		//System.out.println(attr.getName());
		//System.out.println(e.getNewValue().toString());
		
		
		
		EDataType type = attr.getEAttributeType();
		
		
		
	}
    
    private void handleSetEAttributeManyEvent(SetEAttributeManyEvent e, OutputStream out) throws IOException
    {
    	EObject focus_obj = e.getFocusObj();
    	
    	EAttribute attr = e.getEAttribute();
    	
    	EDataType type = attr.getEAttributeType();
    	
    	List<Object> attr_values_list = e.getAttributeValuesList();
    	
    	if(type instanceof EEnum)
    	{
    		//deal
    		
    		
    	}
    	
    	
    	
    	//
    	
    	
    	for(Object obj : attr_values_list)
    	{
    		if(obj != null && obj.toString().equals("null"))
    		{
    			//System.out.println(10);
    		}
    	}
    	//
    	//System.out.println(getTypeID(type));
    	switch(getTypeID(type))
    	{
    	
    	case PersistenceManager.SIMPLE_TYPE_INT:
    		{
    			writePrimitive(out,PersistenceManager.SET_PRIMITIVE_EATTRIBUTE_VALUE);
    			writePrimitive(out,ePackageElementsNamesMap.getID(attr.getName()));
    			writePrimitive(out,changelog.getObjectId(focus_obj));
    			writePrimitive(out,attr_values_list.size());
    			
    			int nullCounter = 0;
    			
    			for(Object obj : attr_values_list)
    			{
    				if(obj == null)
    				{
    					nullCounter ++;
    					continue;
    				}
    				
    				String theType = "java.lang.Integer";
    				try {
						Class<?> theClass = Class.forName(theType);
						System.out.println(classname+"success");
						
						if(theClass.cast(obj) instanceof Integer)
							System.out.println(classname+" yes!");
						
						
					} catch (ClassNotFoundException e1) {
						// TODO Auto-generated catch block
						e1.printStackTrace();
					}
    				writePrimitive(out,(int)obj);
    				//System.out.println(obj);
    			}
    			
    			if(nullCounter > 0)
    			{
    				String[] nulls = new String[nullCounter];
    				
    				Arrays.fill(nulls,"null");
    				
    				writeComplexEAttributes(out,focus_obj,attr,nulls);
    			}
    		}
    		break;
    	case PersistenceManager.SIMPLE_TYPE_SHORT:
    		{
    		
    		}
    		break;
    	case PersistenceManager.SIMPLE_TYPE_LONG:
    		break;
    	case PersistenceManager.SIMPLE_TYPE_FLOAT:
    		break;
    	case PersistenceManager.SIMPLE_TYPE_DOUBLE:
    		break;
    	case PersistenceManager.SIMPLE_TYPE_BOOLEAN:
    		break;
    	case PersistenceManager.SIMPLE_TYPE_CHAR:
    		break;
    	case PersistenceManager.COMPLEX_TYPE:
    		break;
    	}
    	
    	
    	
    	System.exit(0);
    }
    
    private void handlePrimitiveEAtributes(OutputStream out,SetEAttributeManyEvent e, int primitiveType ) throws IOException
    {
    	EObject focus_obj = e.getFocusObj();
    	
    	EAttribute attr = e.getEAttribute();
    	
    	EDataType type = attr.getEAttributeType();
    	
    	List<Object> attr_values_list = e.getAttributeValuesList();
    	
        writePrimitive(out,PersistenceManager.SET_PRIMITIVE_EATTRIBUTE_VALUE);
        writePrimitive(out,ePackageElementsNamesMap.getID(attr.getName()));
        writePrimitive(out,changelog.getObjectId(focus_obj));
        writePrimitive(out,attr_values_list.size());
        
        int nullCounter = 0;
        
        for(Object obj : attr_values_list)
        {
        	if(obj == null)
        	{
        		nullCounter++;
        		continue;
        	}
        	
        	writePrimitive(out,primitiveType,obj);
        }
        
        if(nullCounter > 0) // for obj with null values, serialsie as complex types
        {
        	String[] nullsArray = new String[nullCounter];
        	
        	Arrays.fill(nullsArray,"null");
        	
        	List<Object> nullList = new ArrayList<Object>(Arrays.asList(nullsArray));
        	
        	handleComplexAttributes(out,focus_obj,attr,nullList);
            
        }
    }
    
    private void handleComplexAttributes(OutputStream out,EObject focus_obj,EAttribute attr, List<Object> attr_values)
    {
    	
    }
    private void handleComplexAttributes(OutputStream out,SetEAttributeManyEvent e)
    {
    	handleComplexAttributes(out,e.getFocusObj(),e.getEAttribute(),e.getAttributeValuesList());
    }
    private void writeComplexEAttributes(OutputStream out,EObject focus_obj,EAttribute attr, String[] payload) throws IOException
    {
    	writePrimitive(out,PersistenceManager.SET_COMPLEX_EATTRIBUTE_VALUE);
    	writePrimitive(out,changelog.getObjectId(focus_obj));
    	writePrimitive(out,ePackageElementsNamesMap.getID(attr.getName()));
    	writePrimitive(out,payload.length);
    	
    	for(String str : payload)
    	{
    		writeString(out,str);
    	}
    }
    
   
    
    private int getTypeID(EDataType type)
    {
    	if(simpleTypeNameMap.containsKey(type.getName()))
    	{
    		return simpleTypeNameMap.get(type.getName());
    	}
    	
    	return PersistenceManager.COMPLEX_TYPE;
    }
    
    private void handleSetEReferenceSingleEvent(SetEReferenceSingleEvent e,OutputStream out) throws IOException
    {
    	EObject added_obj = e.getAddedObject();
    	
    	if(e.getNotifierType() == Event.NotifierType.RESOURCE)
    	{
    		
    		if(changelog.addObjectToMap(added_obj))
    		{
    			writePrimitive(out,PersistenceManager.CREATE_AND_ADD_TO_RESOURCE);
    			writePrimitive(out,2);
    			writePrimitive(out,ePackageElementsNamesMap.getID(added_obj.eClass().getName()));
    			writePrimitive(out,changelog.getObjectId(added_obj));
    		}
    		else
    		{
    			writePrimitive(out,PersistenceManager.ADD_TO_RESOURCE);
    			writePrimitive(out,1);
    			writePrimitive(out,changelog.getObjectId(added_obj));
    		}
    	}
    	else if(e.getNotifierType() == Event.NotifierType.EOBJECT)
    	{
    		EObject focus_obj = e.getFocusObject();
    		
    		if(changelog.addObjectToMap(added_obj))
    		{
    			writePrimitive(out,PersistenceManager.CREATE_AND_SET_EREFERENCE_VALUE);
    			writePrimitive(out,changelog.getObjectId(focus_obj));
    			writePrimitive(out,ePackageElementsNamesMap.getID(e.getEReference().getName()));
    			writePrimitive(out,2);
    			writePrimitive(out,ePackageElementsNamesMap.getID(added_obj.eClass().getName()));
    			writePrimitive(out,changelog.getObjectId(added_obj));
    		}
    		else
    		{
    			writePrimitive(out, PersistenceManager.SET_EREFERENCE_VALUE);
    			writePrimitive(out,changelog.getObjectId(focus_obj));
    			writePrimitive(out,ePackageElementsNamesMap.getID(e.getEReference().getName()));
    			writePrimitive(out,1);
    			writePrimitive(out,changelog.getObjectId(added_obj));
    		}
    	}
    }
    
    private void handleUnsetEReferenceSingleEvent(UnsetEReferenceSingleEvent e, OutputStream out) throws IOException
    {
    	if(e.getNotifierType() == Event.NotifierType.RESOURCE)
    	{
    		writePrimitive(out, PersistenceManager.DELETE_FROM_RESOURCE);
    		writePrimitive(out,1);
    		writePrimitive(out,changelog.getObjectId(e.getRemovedObject()));
    	}
    	else if(e.getNotifierType() == Event.NotifierType.EOBJECT)
    	{
    		EObject focus_obj = e.getFocusObject();
    		
    		writePrimitive(out,PersistenceManager.UNSET_EREFERENCE_VALUE);
    		writePrimitive(out,changelog.getObjectId(focus_obj));
    		writePrimitive(out,ePackageElementsNamesMap.getID(e.getEReference().getName()));
    		writePrimitive(out,1);
    		writePrimitive(out,changelog.getObjectId(e.getRemovedObject()));
    	}
    }
    
    
    private void handleSetEReferenceManyEvent(SetEReferenceManyEvent e, OutputStream out) throws IOException
    {
    	TIntArrayList added_obj_list = new TIntArrayList();
    	TIntArrayList obj_create_list = new TIntArrayList();
    	
    	for(EObject obj : e.getEObjectList())
    	{
    		if(changelog.addObjectToMap(obj))
    		{
    			obj_create_list.add(ePackageElementsNamesMap.getID(obj.eClass().getName()));
    			obj_create_list.add(changelog.getObjectId(obj));
    		}
    		else
    		{
    			added_obj_list.add(changelog.getObjectId(obj));
    		}
    	}
    		
    	if(e.getNotifierType() == Event.NotifierType.RESOURCE) 
    	{
    		if(!obj_create_list.isEmpty()) //CREATE_AND_ADD_TO_RESOURCE 
    		{
    			writePrimitive(out,PersistenceManager.CREATE_AND_ADD_TO_RESOURCE);
    			writePrimitive(out,obj_create_list.size());
    			
    			for(TIntIterator it = obj_create_list.iterator(); it.hasNext();)
    			{
    				writePrimitive(out,it.next());
    			}
    			obj_create_list.clear();
    		}
    		if(!added_obj_list.isEmpty()) //ADD TO RESOURCE
    		{
    			writePrimitive(out, PersistenceManager.ADD_TO_RESOURCE);
    			writePrimitive(out,added_obj_list.size());
    			
    			for(TIntIterator it = added_obj_list.iterator(); it.hasNext();)
    			{
    				writePrimitive(out,it.next());
    			}
    			added_obj_list.clear();
    		}
    	}
    	else if(e.getNotifierType() == Event.NotifierType.EOBJECT)
    	{
    		EObject focus_obj = e.getFocusObj(); 
    		
    		if(!obj_create_list.isEmpty())//CREATE_AND_SET_REF_VALUE
    		{
    			writePrimitive(out,PersistenceManager.CREATE_AND_SET_EREFERENCE_VALUE);
    			writePrimitive(out,changelog.getObjectId(focus_obj));
    			writePrimitive(out,ePackageElementsNamesMap.getID(e.getEReference().getName()));
    			writePrimitive(out,obj_create_list.size());
    			
    			for(TIntIterator it = obj_create_list.iterator(); it.hasNext();)
    			{
    				writePrimitive(out,it.next());
    			}
    		}
    		if(!added_obj_list.isEmpty()) //SET_REFERENCE_VALUE
    		{
    			writePrimitive(out,PersistenceManager.SET_EREFERENCE_VALUE);
    			writePrimitive(out,changelog.getObjectId(focus_obj));
    			writePrimitive(out,ePackageElementsNamesMap.getID(e.getEReference().getName()));
    			writePrimitive(out,added_obj_list.size());
    			
    			for(TIntIterator it = added_obj_list.iterator(); it.hasNext();)
    			{
    				writePrimitive(out,it.next());
    			}
    		}
    	}
    }
    
    private void handleUnsetEReferenceManyEvent(UnsetEReferenceManyEvent e, OutputStream out) throws IOException
    {
    	List<EObject> removed_obj_list = e.getObjectList();
    
    	if(e.getNotiferType() == Event.NotifierType.RESOURCE)
    	{
    		writePrimitive(out, PersistenceManager.DELETE_FROM_RESOURCE);
    		writePrimitive(out,removed_obj_list.size());
    		
    		for(EObject obj : removed_obj_list)
    		{
    			writePrimitive(out,changelog.getObjectId(obj));
    		}
    	}
    	else if(e.getNotiferType() == Event.NotifierType.EOBJECT)
    	{
    		EObject focus_obj = e.getFocusObj();
    		
    		writePrimitive(out,PersistenceManager.UNSET_EREFERENCE_VALUE);
    		writePrimitive(out,changelog.getObjectId(focus_obj));
    		writePrimitive(out,ePackageElementsNamesMap.getID(e.getEReference().getName()));
    		writePrimitive(out,removed_obj_list.size());
    		
    		for(EObject obj: removed_obj_list)
    		{
    			writePrimitive(out,changelog.getObjectId(obj));
    		}
    	}
    }
    
	private void writeInitialRecord(OutputStream out) throws IOException 
	{
		EObject obj = null;
		Event e = eventList.get(0);

		switch (e.getEventType()) 
		{
		case Event.SET_EREFERENCE_SINGLE:
			obj = ((SetEReferenceSingleEvent) e).getAddedObject();
			break;
		case Event.SET_EREFERENCE_MANY:
			obj = ((SetEReferenceManyEvent) e).getEObjectList().get(0);
			break;
		default:
			try 
			{
				System.out.println(classname+" "+e.getEventType());
				throw new Exception("Error! first item in events list was not an Add event.");
			} 
			catch (Exception e1) 
			{
				e1.printStackTrace();
				System.exit(0);
			}
		}

		if (obj == null) //tbr
		{
			System.out.println(classname+" "+e.getEventType()); 
			System.exit(0);
		}
		
		
		out.write(FORMAT_ID.getBytes(STRING_ENCODING)); //FORMAT ID
		writePrimitive(out, FORMAT_VERSION); //FORMAT VERSION
		writeString(out,obj.eClass().getEPackage().getNsURI()); //NS URI
	}
	
	
	private void writeString(OutputStream out, String str) throws IOException
	{
		byte[] bytes = str.getBytes(STRING_ENCODING);
	
		writePrimitive(out,bytes.length);
		
		out.write(bytes);
	}
	
	/*private void writePrimitive(OutputStream out, int i) throws IOException
	{
		byte[] bytes = ByteBuffer.allocate(manager.INTEGER_SIZE).putInt(i).array();
		out.write(bytes);
	}*/
	
	private void writePrimitive(OutputStream out, int i) throws IOException
	{
		byte[] bytes = ByteBuffer.allocate(manager.INTEGER_SIZE).putInt(i).array();
		out.write(bytes);
	}
	
	private void writePrimitive(OutputStream out, short s) throws IOException
	{
		byte[] bytes = ByteBuffer.allocate(manager.SHORT_SIZE).putShort(s).array();
		out.write(bytes);
	}
	
	private void writePrimitive(OutputStream out, byte b) throws IOException
	{
		byte[] bytes = ByteBuffer.allocate(manager.BYTE_SIZE).put(b).array();
		out.write(bytes);
	}
	
	private void writePrimitive(OutputStream out, char c) throws IOException
	{
		byte[] bytes = ByteBuffer.allocate(manager.CHAR_SIZE).putChar(c).array();
		out.write(bytes);
	}
	
	private void writePrimitive(OutputStream out, double d) throws IOException
	{
		byte[] bytes = ByteBuffer.allocate(manager.DOUBLE_SIZE).putDouble(d).array();
		out.write(bytes);
	}
	
	private void writePrimitive(OutputStream out, long l) throws IOException
	{
		byte[] bytes = ByteBuffer.allocate(manager.LONG_SIZE).putLong(l).array();
		out.write(bytes);
	}
	
	private void writePrimitive(OutputStream out, int primitiveType, Object obj ) throws IOException
	{
		switch(primitiveType)
		{
		case PersistenceManager.SIMPLE_TYPE_INT:
			writePrimitive(out,(int)obj);
			break;
		case PersistenceManager.SIMPLE_TYPE_BOOLEAN:
			writePrimitive(out,(boolean)obj);
			break;
		case PersistenceManager.SIMPLE_TYPE_BYTE:
			writePrimitive(out,(byte)obj);
			break;
		case PersistenceManager.SIMPLE_TYPE_CHAR:
			writePrimitive(out,(char)obj);
			break;
		case PersistenceManager.SIMPLE_TYPE_DOUBLE:
			writePrimitive(out,(double)obj);
			break;
		case PersistenceManager.SIMPLE_TYPE_FLOAT:
			writePrimitive(out,(short)obj);
			break;
		case PersistenceManager.SIMPLE_TYPE_LONG:
			writePrimitive(out,(long)obj);
			break;
		case PersistenceManager.SIMPLE_TYPE_SHORT:
			writePrimitive(out,(short)obj);
			break;
		}
		
	}
	
	private void writePrimitive(OutputStream out, boolean b) throws IOException
	{
		if(b)
			writePrimitive(out,1);
		else
			writePrimitive(out,0);
	}
	
	
	
}
