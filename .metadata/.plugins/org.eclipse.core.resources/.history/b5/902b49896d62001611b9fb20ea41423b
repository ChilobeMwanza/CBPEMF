package dynamic_emf_tests;

import static org.junit.Assert.assertTrue;

import java.io.File;
import java.io.IOException;

import org.eclipse.emf.common.util.URI;
import org.eclipse.emf.ecore.EAttribute;
import org.eclipse.emf.ecore.EObject;
import org.eclipse.emf.ecore.resource.Resource;
import org.junit.Test;

import impl.DeltaResourceImpl;
import university.University;

public class GeneralSaveTests extends TestBase 
{
	/*Calling save() serialises all monitored changes (notifications) and clears these
	 * Notifications from the event list. Calling save repeatedly without having made
	 * any changes to the model should not result in subsequent modifications of the save
	 * file.
	 */
	@Test
	public void testRepeatedSaveNoModification() throws IOException
	{
		Resource res = new DeltaResourceImpl(URI.createURI(FILE_SAVE_LOCATION));
		
		EObject uni = createEObject("University");
		
		res.getContents().add(uni);
		
		//perform first save
		res.save(null);
		
		//save last modified time
		File file = new File(FILE_SAVE_LOCATION);
		Long timeStamp = file.lastModified();
		
		//perform further saves without modifiying the resource
		res.save(null);
		res.save(null);
		
		//check that the file has not been modified
		assertTrue(timeStamp == file.lastModified());
	}
	
	/*
	 * Test that making initial modifications, calling save, making more modifications,
	 *  results in the save file being modified accordingly.
	 */
	@Test
	public void testMultipleSaveWithModifications() throws IOException, InterruptedException
	{
		Resource res = new DeltaResourceImpl(URI.createURI(FILE_SAVE_LOCATION));
		
		EObject uni = createEObject("University");
		res.getContents().add(uni1);
		
		//perform first save
		res.save(null);
		
		//save last modified time
		File file = new File(FILE_SAVE_LOCATION);

		Long timeStamp = file.lastModified();
		
		//make further modifications
		EAttribute uniNameAttr = (EAttribute)uni.eClass().getEStructuralFeature("name");
		uni.eSet(uniNameAttr, "York University");
		uni1.setName("York University");
		
		//wait a little before save to ensure modification does not happen too quickly
		Thread.sleep(10);
		
		res.save(null);
		
		//check that the file has been modified
		assertFalse(timeStamp == file.lastModified());
		
	}
}
