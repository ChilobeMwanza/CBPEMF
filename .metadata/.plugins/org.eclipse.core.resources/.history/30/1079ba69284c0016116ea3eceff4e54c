package change;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.UUID;


public class ChangeLog 
{
	//public static final ChangeLog INSTANCE = new ChangeLog();
	
	
	private List<AbstractEntry> eventsList = new ArrayList<AbstractEntry>();

	public void addEvent(AbstractEntry entry)
	{
		eventsList.add(entry);
	}
	
	public List<AbstractEntry> getEventsList()
	{
		return eventsList;
	}
	
	public void sortChangeLog(List<AbstractEntry> list)
	{
		UUID currentUUID = null;//eventsList.get(1).getUUID(); //second entry of unsorted changelog is always a create
		List<AbstractEntry> outputList = new ArrayList<AbstractEntry>();
		
		
		for(Iterator<AbstractEntry> it = list.iterator(); it.hasNext();)
		{
			AbstractEntry e = it.next();
			
			if(e instanceof NewObjectEntry)
			{
				if(currentUUID == null)
					currentUUID = e.getUUID();
				outputList.add(e);
				it.remove(); 
			}
			else if (e instanceof SetAttributeEntry && e.getUUID() == currentUUID)
			{
			    List<AbstractEntry> temp = new ArrayList<AbstractEntry>();
				SetAttributeEntry s = (SetAttributeEntry)e;
				
				if(s.geteAttribute().isMany())
				{
					temp.add(e);
					it.remove();
				}
				if(!s.geteAttribute().isMany())
				{
					outputList.add(e);
					it.remove();
				}
				outputList.addAll(temp);
			}
		}
	}
	
	public void showLogEntries(List<AbstractEntry> list)
	{
		for(AbstractEntry e : list)
		{
			if(e instanceof InitialEntry)
			{
				//System.out.println("InitialEntry:");
				System.out.println("NamespaceURI = "+e.getEObject().eClass().getEPackage().getNsURI());
				
			}
			if(e instanceof NewObjectEntry)
			{
				//System.out.println("NewObjectEntry:");
				System.out.println("CREATE "+e.getEObject().eClass().getName()+" "+e.getUUID().toString());
			}
			if(e instanceof SetAttributeEntry)
			{
				SetAttributeEntry s = (SetAttributeEntry)e;
				//System.out.println("Set Attribute Entry");
				System.out.println("SET " + e.getEObject().eClass().getName()+" "+e.getUUID()+" "+s.geteAttribute().getName());
			}
		}
	}
	
	public void showLogEntries()
	{
		showLogEntries(eventsList);
	}
}
